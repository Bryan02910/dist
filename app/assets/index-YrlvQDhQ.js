import{r as o,M as me,j as e}from"./index-UyDEpSKi.js";import{T as je,A as y}from"./ToastAutoHide-mD-74I2T.js";import{P as xe}from"./Page-DWSL0diS.js";import{E as be}from"./jspdf.plugin.autotable-DmuIJyGd.js";import{i as _e}from"./index-tCDBB_r2.js";import{C as ve}from"./Container-uQWJgnJV.js";import{T as w,B as ge}from"./Box-BLXI0_F0.js";import{G as h}from"./Grid-CfjZ72w2.js";import{T as c,a as Ce,S as ye}from"./TextField-BGn-4xfW.js";import{B as p}from"./Button-CjDs8j-X.js";import{S as Y}from"./SearchOutlined-BtG2iM2l.js";import{D as Q,a as $,b as q,T as n,c as J}from"./TableCell-B8HtnHjl.js";import{T as W,a as B,b as N,c as b,d as P}from"./TableRow-B-cCF0_f.js";import{P as M}from"./ButtonBase-Bhi2RUyb.js";import{M as E}from"./MenuItem-B_SiXQ1x.js";import{I as X}from"./Grow-41TwNg0m.js";import{A as Se,D as Fe}from"./DeleteOutline-DAPNekcB.js";import{S as Te}from"./Stack-CILUL872.js";import"./useThemeProps-D04-WiJJ.js";import"./Menu-9ysSaJL7.js";const Ye=()=>{o.useContext(me);const[d,u]=o.useState([{id:"",nombre:"",presentacion:"",precio_venta_caja:"",precio_venta_blister:"",precio_venta_unidad:"",cantidad:"",precio_mayor:""}]);o.useState([{id:"",nombre:"",correo:"",dpi:"",nit:"",telefono:"",direccion:""}]);const[S,O]=o.useState(0),[F,V]=o.useState(""),[T,f]=o.useState(""),[k,D]=o.useState(""),[Z,ee]=o.useState(""),[_,v]=o.useState({ident:null,message:null,type:null}),[te,A]=o.useState(!1),[ae,L]=o.useState(!1),[R,G]=o.useState([]),[g,K]=o.useState(""),ne=()=>{A(!0),ie()},re=()=>{L(!0),se()},z=()=>{A(!1)},C=()=>{L(!1)},se=async()=>{try{const{data:t}=await y().get("/clientes");G(t)}catch(t){console.error("Error al obtener los clientes:",t)}},ie=async()=>{try{const{data:t}=await y().get("/farmacos_venta");G(t)}catch(t){console.error("Error al obtener los fármacos:",t)}},oe=t=>{u(r=>{const a=r.findIndex(s=>s.id==="");if(a!==-1){const s=[...r];return s[a]={id:t.id,nombre:t.nombre,presentacion:t.presentacion,precio_venta_caja:t.precio_venta_caja,precio_venta_blister:t.precio_venta_blister,precio_venta_unidad:t.precio_venta_unidad,cantidad:""},s}else return[...r,{id:t.id,nombre:t.nombre,presentacion:t.presentacion,precio_venta_caja:t.precio_venta_caja,precio_venta_blister:t.precio_venta_blister,precio_venta_unidad:t.precio_venta_unidad,cantidad:""}]}),z()},le=t=>{f(t.nombre||""),D(t.nit||""),C()},I=async(t,{target:r})=>{var j;const{name:a,value:s}=r,i=[...d];if(i[t][a]=s||"",a==="id"&&s)try{const{data:x}=await y().get(`/farmaco/${s}`);x?i[t]={...i[t],...x}:i[t]={...i[t],id:s,nombre:"",precio_venta_caja:"",precio_venta_blister:"",precio_venta_unidad:"",presentacion:"caja"},u(i)}catch(x){v({ident:new Date().getTime(),message:"Error al obtener los datos del fármaco",type:"error"}),((j=x.response)==null?void 0:j.status)===404&&(i[t]={...i[t],id:s,nombre:"",precio_venta_caja:"",precio_venta_blister:"",precio_venta_unidad:"",presentacion:"caja"},u(i))}else i[t][a]=s,u(i);U(i)},ce=(t,r)=>{const a=[...d];a[t].presentacion=r,u(a)},H=()=>`REC-${Date.now()}`,de=()=>{u([...d,{id:"",nombre:"",presentacion:"",precio_venta_caja:"",precio_venta_blister:"",precio_venta_unidad:"",cantidad:""}])},ue=t=>{const r=[...d];r.splice(t,1),u(r),U(r)},U=t=>{const r=t.reduce((a,s)=>{let i=0;switch(s.presentacion){case"caja":i=parseFloat(s.precio_venta_caja)||0;break;case"blister":i=parseFloat(s.precio_venta_blister)||0;break;case"unidad":i=parseFloat(s.precio_venta_unidad)||0;break;default:i=0;break}const j=parseInt(s.cantidad,10)||0;return a+i*j},0);O(r)},he=()=>{const t=new be("portrait","mm",[150,75]),r=new Date().toLocaleDateString(),a=_e.Logo,s=()=>{t.addImage(a,"JPEG",5,5,25,15)},i=[{label:"Fecha:",value:r},{label:"No. Recibo de venta:",value:F},{label:"Comprador final",value:T},{label:"NIT:",value:k}];t.autoTable({body:i.map(l=>[l.label,l.value]),startY:30,margin:{horizontal:5},theme:"plain",styles:{fontSize:8,cellPadding:1},columnStyles:{0:{cellWidth:35,fontStyle:"bold"},1:{cellWidth:40}}});const j=[{header:"ID",dataKey:"id"},{header:"Nombre",dataKey:"nombre"},{header:"Cant.",dataKey:"cantidad"},{header:"Precio",dataKey:"precio_venta"},{header:"Subtotal",dataKey:"subtotal"}],x=d.map(l=>{let m=0;switch(l.presentacion){case"caja":m=parseFloat(l.precio_venta_caja)||0;break;case"blister":m=parseFloat(l.precio_venta_blister)||0;break;case"unidad":m=parseFloat(l.precio_venta_unidad)||0;break;default:m=0;break}return{id:l.id,nombre:l.nombre,cantidad:parseInt(l.cantidad||0,10),precio_venta:m.toFixed(2),subtotal:(m*parseInt(l.cantidad||0,10)).toFixed(2)}});s(),t.autoTable({columns:j,body:x,startY:t.lastAutoTable.finalY+5,margin:{horizontal:2},theme:"grid",styles:{fontSize:8,cellPadding:1},headStyles:{fillColor:[22,160,133]}}),t.text(`Total Venta: Q${S.toFixed(2)}`,5,t.lastAutoTable.finalY+5),t.save("venta_recibo.pdf")},pe=async()=>{var t,r;if(d.every(a=>!a.cantidad||parseInt(a.cantidad)<=0)){v({ident:new Date().getTime(),message:"Debes agregar al menos un fármaco con cantidad válida.",type:"error"});return}try{const{data:a}=await y().post("/guardar_farmaco_venta",{farmacos:d,Nofactura:F,total_venta:S,nombre_cliente:T,nit:k});v({ident:new Date().getTime(),message:a.message,type:"success"}),u([{id:"",nombre:"",presentacion:"",precio_venta:"",cantidad:""}]),V(H()),f(""),D(""),O(0)}catch(a){v({ident:new Date().getTime(),message:((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.message)||"Error al guardar la venta.",type:"error"})}};return o.useEffect(()=>{const r=new Date().toISOString().split("T")[0];ee(r);const a=H();V(a)},[]),e.jsx(xe,{title:"Chapina| Ventas",children:e.jsxs(ve,{children:[e.jsx(w,{variant:"h4",gutterBottom:!0,children:"Ventas"}),e.jsxs(ge,{sx:{mt:2},children:[_.message&&e.jsx(je,{message:_.message,type:_.type,id:_.ident}),e.jsxs(h,{container:!0,spacing:2,sx:{mb:3},children:[e.jsx(h,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(w,{variant:"h6",children:["Fecha de compra: ",Z]})}),e.jsx(h,{item:!0,xs:12,sm:6,md:3,children:e.jsx(c,{label:"No. de documento",value:F,fullWidth:!0,variant:"outlined",InputProps:{readOnly:!0}})}),e.jsx(h,{item:!0,xs:12,sm:6,md:3,children:e.jsx(p,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:re,children:"Buscar cliente"})}),e.jsx(h,{item:!0,xs:13,sm:6,md:3,children:e.jsx(c,{label:"Comprador final",value:T,onChange:t=>f(t.target.value),fullWidth:!0,variant:"outlined"})}),e.jsx(h,{item:!0,xs:12,sm:6,md:3,children:e.jsx(c,{label:"Nit",value:k,onChange:t=>D(t.target.value),fullWidth:!0,variant:"outlined"})})]}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:ne,children:"Buscar Fármaco"}),e.jsx(h,{children:e.jsxs(Q,{open:ae,onClose:C,fullWidth:!0,maxWidth:"md",children:[e.jsx($,{children:"Buscar cliente"}),e.jsxs(q,{children:[e.jsx(c,{label:"Buscar por nombre",value:g,onChange:t=>K(t.target.value),fullWidth:!0,margin:"dense"}),e.jsx(W,{component:M,children:e.jsxs(B,{children:[e.jsx(N,{children:e.jsxs(b,{children:[e.jsx(n,{children:"ID"}),e.jsx(n,{children:"Nombre"}),e.jsx(n,{children:"Nit"})]})}),e.jsx(P,{children:R.filter(t=>t.nombre.toLowerCase().includes(g.toLowerCase())).map(t=>e.jsxs(b,{children:[e.jsx(n,{children:t.id}),e.jsx(n,{children:t.nombre}),e.jsx(n,{children:t.nit}),e.jsx(n,{children:e.jsx(p,{variant:"contained",onClick:()=>le(t),children:"Seleccionar"})})]},t.id))})]})})]}),e.jsx(J,{children:e.jsx(p,{onClick:C,children:"Cerrar"})})]})}),e.jsx(h,{children:e.jsxs(Q,{open:te,onClose:C,fullWidth:!0,maxWidth:"md",children:[e.jsx($,{children:"Buscar Fármaco"}),e.jsxs(q,{children:[e.jsx(c,{label:"Buscar por nombre",value:g,onChange:t=>K(t.target.value),fullWidth:!0,margin:"dense"}),e.jsx(W,{component:M,children:e.jsxs(B,{children:[e.jsx(N,{children:e.jsxs(b,{children:[e.jsx(n,{children:"ID"}),e.jsx(n,{children:"Nombre"}),e.jsx(n,{children:"Stock Caja"}),e.jsx(n,{children:"Stock Blister"}),e.jsx(n,{children:"Stock Unidad"}),e.jsx(n,{children:"Acciones"})]})}),e.jsx(P,{children:R.filter(t=>t.nombre.toLowerCase().includes(g.toLowerCase())).map(t=>e.jsxs(b,{children:[e.jsx(n,{children:t.id}),e.jsx(n,{children:t.nombre}),e.jsx(n,{children:t.stock_caja}),e.jsx(n,{children:t.stock_blister}),e.jsx(n,{children:t.stock_unidad}),e.jsx(n,{children:e.jsx(p,{variant:"contained",onClick:()=>oe(t),children:"Seleccionar"})})]},t.id))})]})})]}),e.jsx(J,{children:e.jsx(p,{onClick:z,children:"Cerrar"})})]})}),e.jsx(W,{component:M,children:e.jsxs(B,{children:[e.jsx(N,{children:e.jsxs(b,{children:[e.jsx(n,{children:"ID"}),e.jsx(n,{children:"Nombre"}),e.jsx(n,{children:"Tipo Presentación"}),e.jsx(n,{children:"Precio Venta"}),e.jsx(n,{children:"Cantidad"}),e.jsx(n,{children:"Subtotal"}),e.jsx(n,{align:"center",children:"Acciones"})]})}),e.jsx(P,{children:d.map((t,r)=>e.jsxs(b,{children:[e.jsx(n,{children:e.jsx(c,{name:"id",value:t.id,onChange:a=>I(r,a),fullWidth:!0})}),e.jsx(n,{children:t.nombre}),e.jsx(n,{children:e.jsx(Ce,{fullWidth:!0,children:e.jsxs(ye,{name:"presentacion",value:t.presentacion,onChange:a=>{ce(r,a.target.value),I(r,a)},children:[e.jsx(E,{value:"caja",children:"Caja"}),e.jsx(E,{value:"blister",children:"Blister"}),e.jsx(E,{value:"unidad",children:"Unidad"})]})})}),t.presentacion==="caja"&&e.jsx(e.Fragment,{children:e.jsx(n,{children:e.jsx(c,{name:"precio_venta_caja",value:t.precio_venta_caja,fullWidth:!0,disabled:!0})})}),t.presentacion==="unidad"&&e.jsx(e.Fragment,{children:e.jsx(n,{children:e.jsx(c,{name:"precio_venta_unidad",value:t.precio_venta_unidad,fullWidth:!0,disabled:!0})})}),t.presentacion==="blister"&&e.jsx(e.Fragment,{children:e.jsx(n,{children:e.jsx(c,{name:"precio_venta_blister",value:t.precio_venta_blister,fullWidth:!0,disabled:!0})})}),e.jsx(n,{children:e.jsx(c,{name:"cantidad",type:"number",value:t.cantidad,onChange:a=>I(r,a),fullWidth:!0})}),e.jsxs(n,{children:["Q",(()=>{let a=0;switch(t.presentacion){case"caja":a=parseFloat(t.precio_venta_caja)||0;break;case"blister":a=parseFloat(t.precio_venta_blister)||0;break;case"unidad":a=parseFloat(t.precio_venta_unidad)||0;break;default:a=0;break}const s=parseInt(t.cantidad||0,10);return(a*s).toFixed(2)})()]}),e.jsxs(n,{align:"center",children:[e.jsx(X,{color:"primary",onClick:de,children:e.jsx(Se,{})}),r>0&&e.jsx(X,{color:"error",onClick:()=>ue(r),children:e.jsx(Fe,{})})]})]},r))})]})}),e.jsxs(w,{variant:"h6",mt:2,children:["Total: Q",S.toFixed(2)]}),e.jsxs(Te,{direction:"row",spacing:2,mt:2,children:[e.jsx(p,{variant:"contained",color:"primary",onClick:pe,children:"Guardar Venta"}),e.jsx(p,{variant:"contained",color:"secondary",onClick:he,children:"Generar PDF"})]})]})]})})};export{Ye as default};
