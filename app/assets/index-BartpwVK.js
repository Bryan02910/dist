import{r as n,M as I,j as e}from"./index-UyDEpSKi.js";import{P as L}from"./Page-DWSL0diS.js";import{T as O,A as P}from"./ToastAutoHide-mD-74I2T.js";import{E as q}from"./jspdf.plugin.autotable-DmuIJyGd.js";import{u as C,w as J}from"./xlsx-DjuO7_Ju.js";import{i as U}from"./index-tCDBB_r2.js";import{C as V}from"./Container-uQWJgnJV.js";import{T as K}from"./Box-BLXI0_F0.js";import{T as Q}from"./TextField-BGn-4xfW.js";import{B as D}from"./ButtonGroup-yBcTUZVq.js";import{B as l}from"./Button-CjDs8j-X.js";import{T as X,a as S,b as v,c as h,d as k}from"./TableRow-B-cCF0_f.js";import{T as r,D as Z,a as ee,b as te,c as re}from"./TableCell-B8HtnHjl.js";import{T as ae}from"./TablePagination-CBjQ43ZL.js";import"./Grow-41TwNg0m.js";import"./ButtonBase-Bhi2RUyb.js";import"./useThemeProps-D04-WiJJ.js";import"./Menu-9ysSaJL7.js";import"./Toolbar-D0r--W_a.js";import"./MenuItem-B_SiXQ1x.js";const Pe=()=>{n.useContext(I);const[A,E]=n.useState([]),[u,b]=n.useState([]),[m,y]=n.useState({ident:null,message:null,type:null}),[f,F]=n.useState(0),[p,R]=n.useState(5),[g,N]=n.useState(""),[H,T]=n.useState(!1),[c,x]=n.useState("");n.useEffect(()=>{let t=!0;return(async()=>{try{const{data:s}=await P().get("/historial_compras");t&&E(s)}catch{t&&y({ident:new Date().getTime(),message:"Error al cargar el historial de compras",type:"error"})}})(),()=>{t=!1}},[]);const B=async t=>{try{const{data:a}=await P().get(`/detalle_compras/${t}`);b(Array.isArray(a)?a:[]),T(!0)}catch{y({ident:new Date().getTime(),message:"Error al cargar los detalles de la compra",type:"error"})}},M=(t,a)=>F(a),G=t=>{R(parseInt(t.target.value,10)),F(0)},w=()=>{T(!1),b([])},d=(t=>{const a=new Date;if(c==="month")return t.filter(s=>{const o=new Date(s.fecha_compra);return o.getMonth()===a.getMonth()&&o.getFullYear()===a.getFullYear()});if(c==="week"){const s=new Date(a.setDate(a.getDate()-a.getDay()));return t.filter(o=>new Date(o.fecha_compra)>=s)}return c==="year"?t.filter(s=>new Date(s.fecha_compra).getFullYear()===a.getFullYear()):t})(A.filter(t=>t.Nofactura.toString().includes(g)||t.fecha_compra.toString().includes(g)||t.proveedor.toString().includes(g))),W=()=>{const t=new q("landscape","mm","a4"),a=U.Logo,s=()=>{t.addImage(a,"JPEG",t.internal.pageSize.getWidth()-40-10,10,40,30)},o=`Reporte de Compras - ${c?`Filtro: ${c}`:"Todas las Compras"}`;t.setFontSize(14),t.text(o,20,15);const j=d.map(i=>[i.Nofactura,i.fecha_compra,i.proveedor,i.total_compra.toFixed(2)]),$=["No. de recibo","Fecha","Proveedor","Total"],z=d.reduce((i,_)=>i+parseFloat(_.total_compra||0),0).toFixed(2);j.push(["","","Total General",z]),s(),t.autoTable({head:[$],body:j,startY:30,theme:"grid",styles:{fontSize:10,cellPadding:3},headStyles:{fillColor:[22,160,133]},didDrawPage:i=>{s()}}),t.save(`Reporte_Compras_${c||"todas"}.pdf`)},Y=()=>{const t=d.map(o=>({"No. de recibo":o.Nofactura,Fecha:o.fecha_compra,Proveedor:o.proveedor,Total:o.total_compra.toFixed(2)})),a=C.json_to_sheet(t);a.A1.s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"16A085"}}};for(let o in a)o[0]!=="!"&&(a[o].s={font:{color:{rgb:"000000"}},border:{top:{style:"thin",color:{rgb:"000000"}},bottom:{style:"thin",color:{rgb:"000000"}},left:{style:"thin",color:{rgb:"000000"}},right:{style:"thin",color:{rgb:"000000"}}}});const s=C.book_new();C.book_append_sheet(s,a,"Compras"),J(s,`Reporte_Compras_${c||"todas"}.xlsx`)};return e.jsx(L,{title:"Chapina| Historial de compras",children:e.jsxs(V,{children:[e.jsx(K,{variant:"h4",gutterBottom:!0,children:"Historial de Compras"}),m.message&&e.jsx(O,{message:m.message,type:m.type,id:m.ident}),e.jsx(Q,{label:"Buscar por No. de factura o fecha",variant:"outlined",fullWidth:!0,value:g,onChange:t=>N(t.target.value),sx:{mb:2}}),e.jsxs(D,{variant:"contained",sx:{mb:2},children:[e.jsx(l,{onClick:()=>x("week"),children:"Esta Semana"}),e.jsx(l,{onClick:()=>x("month"),children:"Este Mes"}),e.jsx(l,{onClick:()=>x("year"),children:"Este AÃ±o"}),e.jsx(l,{onClick:()=>x(""),children:"Todas"})]}),e.jsxs(D,{variant:"contained",sx:{mb:2},children:[e.jsx(l,{onClick:W,children:"Generar PDF"}),e.jsx(l,{onClick:Y,children:"Generar Excel"})]}),e.jsx(X,{children:e.jsxs(S,{children:[e.jsx(v,{children:e.jsxs(h,{children:[e.jsx(r,{children:"No. de documento"}),e.jsx(r,{children:"Tipo de documento"}),e.jsx(r,{children:"Fecha"}),e.jsx(r,{children:"Proveedor"}),e.jsx(r,{children:"Total"}),e.jsx(r,{align:"right",children:"Acciones"})]})}),e.jsx(k,{children:d.slice(f*p,f*p+p).map(t=>e.jsxs(h,{children:[e.jsx(r,{children:t.Nofactura}),e.jsx(r,{children:t.tipo_documento}),e.jsx(r,{children:t.fecha_compra}),e.jsx(r,{children:t.proveedor}),e.jsx(r,{children:t.total_compra.toFixed(2)}),e.jsx(r,{align:"right",children:e.jsx(l,{variant:"outlined",onClick:()=>B(t.Nofactura),children:"Ver Detalles"})})]},t.id))})]})}),e.jsx(ae,{rowsPerPageOptions:[5,10,25],component:"div",count:d.length,rowsPerPage:p,page:f,onPageChange:M,onRowsPerPageChange:G}),e.jsxs(Z,{open:H,onClose:w,children:[e.jsx(ee,{children:"Detalles de la Compra"}),e.jsx(te,{children:e.jsxs(S,{children:[e.jsx(v,{children:e.jsxs(h,{children:[e.jsx(r,{children:"Farmaco"}),e.jsx(r,{children:"Cantidad"}),e.jsx(r,{children:"Precio de Compra"}),e.jsx(r,{children:"Total"})]})}),e.jsx(k,{children:Array.isArray(u)&&u.length>0?u.map(t=>e.jsxs(h,{children:[e.jsx(r,{children:t.nombre_farmaco}),e.jsx(r,{children:t.cantidad}),e.jsx(r,{children:t.precio_compra.toFixed(2)}),e.jsx(r,{children:t.total_farmaco.toFixed(2)})]},t.detalle_id)):e.jsx(h,{children:e.jsx(r,{colSpan:4,align:"center",children:"No hay detalles disponibles"})})})]})}),e.jsx(re,{children:e.jsx(l,{onClick:w,color:"primary",children:"Cerrar"})})]})]})})};export{Pe as default};
